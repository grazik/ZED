---
title: "COVID19 project"
author: "Michal Graziowski"
date: "`r format(Sys.time(), '%d.%m.%Y')`r"
output: 
  html_document:
    toc: true
    toc_float: true
    toc_depth: 2
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(readxl)
library(dplyr)
library(tidyr)
library(stringr)
library(ggplot2)
library(plotly)
```

```{r load data, include=FALSE}
original_data <- read_excel("./wuhan_blood_sample_data_Jan_Feb_2020.xlsx")
```

```{r tranform data, include=FALSE}
# merged cells have empty value, thus Patients ids are mostly NA.

df <- original_data %>% 
  rename_with(function(name) toupper(str_replace_all(name, " ", "_"))) %>%
  tidyr::fill(PATIENT_ID) %>%
  group_by(PATIENT_ID) %T>%
  {options(warn=-1)} %>% # some encoding issues
  summarise(across(!RE_DATE, mean, na.rm=TRUE), .groups = "keep")  %T>%
  {options(warn=0)} %>%
  mutate(GENDER = if_else(GENDER == 1, "MALE", "FEMALE")) %>%
  mutate(HAS_SURVIVED = if_else(OUTCOME == 1, FALSE, TRUE), .after="OUTCOME") %>%
  mutate(DAYS_COUNT =  as.numeric(as.Date(DISCHARGE_TIME) - as.Date(ADMISSION_TIME)), .after="PATIENT_ID") %>%
  select(!c(DISCHARGE_TIME, ADMISSION_TIME, OUTCOME))

head(df)
```

# Executive summary
Bla Bla Bla

# Used libraries
* `readxl`
* `dplyr`
* `tidyr`

# Dataset description

# Statistics
## Overall fatality
```{r overall fatality, echo=FALSE}
dfByOutcome <- df %>%
  group_by(HAS_SURVIVED) %>%
  tally(name="COUNT")


graph <- ggplot(
  dfByOutcome,
  aes(x=HAS_SURVIVED, y=COUNT, fill=HAS_SURVIVED)
) +
  geom_bar(stat="identity",
  position="identity")

ggplotly(graph)
```

## Gender based
```{r division by gender, echo=FALSE}
dfByGender <- df %>%
  group_by(GENDER) %>%
  tally(name="COUNT")


graph <- ggplot(
  dfByGender,
  aes(x=GENDER, y=COUNT, fill=GENDER)
) +
  geom_bar(stat="identity",
  position="identity")

ggplotly(graph)
```

```{r outcomes by gender, echo=FALSE, warning=FALSE}
fatalityByGender <- df %>%
  group_by(GENDER, HAS_SURVIVED) %>%
  tally(name="COUNT")

graph <- ggplot(fatalityByGender, aes(x=HAS_SURVIVED, y=COUNT, fill=HAS_SURVIVED))+
  geom_bar(stat='identity')+
  facet_wrap(~GENDER)

ggplotly(graph)
```

## By Age
```{r histogram by age, echo=FALSE}
graph <-ggplot(df, aes(x=AGE, fill=GENDER)) + 
  geom_histogram(color="black", binwidth=5, alpha=0.5, position="identity")

ggplotly(graph)
```

```{r histogram of those who didnt survive by age, echo=FALSE, warning=FALSE}
graph <-ggplot(df %>% filter(HAS_SURVIVED == FALSE), aes(x=AGE)) + 
  geom_histogram(color="black", binwidth=5, position="identity")

ggplotly(graph)
```

```{r histogram of those who didnt survive by age and gender, echo=FALSE, warning=FALSE}
graph <-ggplot(df %>% filter(HAS_SURVIVED == FALSE), aes(x=AGE, fill=GENDER)) + 
  geom_histogram(color="black", binwidth=5, alpha=0.5, position="identity")

ggplotly(graph)
```